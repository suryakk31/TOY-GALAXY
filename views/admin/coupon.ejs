<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coupon</title>
  <link rel="stylesheet" href="/css/admin/coupon.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* Modal Background */
    .modal {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5); 
      padding-top: 50px; 
    }
    
    /* Modal Content */
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 8px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
      width: 90%;
      max-width: 500px;
      animation: fadeIn 0.3s ease; 
    }
    
    /* Close Button */
    .close {
      color: #666;
      float: right;
      font-size: 24px; 
      font-weight: bold;
      transition: color 0.3s; 
    }
    
    .close:hover,
    .close:focus {
      color: #333; 
      text-decoration: none;
      cursor: pointer;
    }
    
    /* Fade-in Animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  </style>

</head>
<body>
  <header>
    <div class="top-nav">
      <div class="logo">
        <h1>Kids Kastle</h1>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="Search...">
      </div>
      <div class="profile-logout">
        <a href="/logout" class="logout-btn">Logout</a>
      </div>
    </div>
  </header>
  
  <nav>
    <ul>
      <li><a href="/admin/adminDashboard"><i class='bx bx-home'></i> Dashboard</a></li>
      <li><a href="/admin/userManagement" ><i class='bx bx-user'></i> User Management</a></li>
      <li><a href="/admin/category"><i class='bx bx-category'></i> Category</a></li>
      <li><a href="/admin/products"><i class='bx bx-box'></i> Products</a></li>
      <li><a href="/admin/orders"><i class='bx bx-cart'></i> Orders</a></li>
      <li><a href="/admin/coupon" class="active"><i class='bx bx-gift'></i> Coupon</a></li>
      <li><a href="/admin/sales-report"><i class='bx bx-line-chart'></i> Sales Report</a></li>
      <li><a href="/banner"><i class='bx bx-image'></i> Banner</a></li>
      <li><a href="/chat"><i class='bx bx-chat'></i> Chat</a></li>
      <li><a href="/analytics"><i class='bx bx-bar-chart-alt-2'></i> Analytics</a></li>
      <li><a href="/notifications"><i class='bx bx-bell'></i> Notifications</a></li>
      <li><a href="/settings"><i class='bx bx-cog'></i> Settings</a></li>
    </ul>
  </nav>
  
  <div class="table-container">
    <button class="add-coupon-btn">Add Coupon</button>
    <table>
      <thead>
        <tr>
          <th>Coupon Code</th>
          <th>Discount (%)</th>
          <th>Minimum Amount</th>
          <th>Maximum Amount</th>
          <th>Expiry Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% coupons.forEach(function(coupon) { %>
          <tr>
            <td><%= coupon.couponCode %></td>
            <td><%= coupon.discount %>%</td>
            <td><%= coupon.minAmount %></td>
            <td><%= coupon.maxAmount %></td>
            <td>
              <%= new Date(coupon.expiryDate).toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              }) %>
            </td>
            <td>
              <form action="/admin/coupons/<%= coupon._id %>/delete" method="POST" class="delete-form" style="display: inline;">
                <i class="bx bx-trash delete-icon" onclick="this.closest('form').submit()"></i>
              </form>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Coupon Modal -->
  <div id="couponModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Add Coupon</h2>
      <form id="couponForm">
        <!-- Coupon Description -->
        <label for="description">Coupon Description:</label>
        <input type="text" id="description" name="description" required>
        
        <label for="couponCode">Coupon Code:</label>
        <input type="text" id="couponCode" name="couponCode" required>
        
        <label for="discount">Coupon Discount (%):</label>
        <input type="number" id="discount" name="discount" required min="0" max="100">
        
        <label for="expiryDate">Expiry Date:</label>
        <input type="date" id="expiryDate" name="expiryDate" required>

        <label for="minAmount">Minimum Amount:</label>
        <input type="number" id="minAmount" name="minAmount">

        <label for="maxAmount">Maximum Amount:</label>
        <input type="number" id="maxAmount" name="maxAmount">
        
        <button type="submit">Add Coupon</button>
      </form>
    </div>
  </div>

  <script>
  
    const modal = document.getElementById("couponModal");
    const closeModal = document.querySelector(".close");
    const addCouponBtn = document.querySelector(".add-coupon-btn");
    const couponForm = document.getElementById("couponForm");
    const couponTable = document.querySelector("table tbody");
  
    
    addCouponBtn.addEventListener("click", () => {
      modal.style.display = "block";
    });
  
   
    closeModal.addEventListener("click", () => {
      modal.style.display = "none";
    });
  
 
    window.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });

    document.getElementById('couponCode').addEventListener('blur', async function() {
        const couponCode = this.value.trim();
        if (!couponCode) return;

        try {
            const response = await fetch(`/admin/coupon/exists?couponCode=${couponCode}`);
            const data = await response.json();
            if (data.exists) {
                Swal.fire("Error", "Coupon code already exists", "error");
            }
        } catch (error) {
            console.error("Error checking coupon code:", error);
        }
    });
  
   
    function addCouponToTable(coupon) {
      const newRow = document.createElement("tr");
      newRow.innerHTML = `
        <td>${coupon.couponCode}</td>
        <td>${coupon.discount}%</td>
        <td>${coupon.minAmount}</td>
        <td>${coupon.maxAmount}</td>
        <td>${new Date(coupon.expiryDate).toLocaleDateString()}</td>
        <td>
          <form action="/admin/coupons/${coupon._id}/delete" method="POST" class="delete-form" style="display: inline;">
            <i class="bx bx-trash delete-icon" onclick="this.closest('form').submit()"></i>
          </form>
        </td>
      `;
      couponTable.appendChild(newRow);
    }

 
    
    couponForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const couponCode = document.getElementById("couponCode").value.trim(); // Ensure no extra spaces
      if (!couponCode) {
          Swal.fire("Error", "Coupon code is required", "error");
          return;
      }
      
      const formData = new FormData(couponForm);
      const couponData = Object.fromEntries(formData.entries());

      try {
          const response = await fetch("/admin/coupon", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify(couponData),
          });

          if (response.ok) {
              const newCoupon = await response.json();
              addCouponToTable(newCoupon);
              couponForm.reset();
              modal.style.display = "none";
              Swal.fire("Success", "Coupon added successfully!", "success");
          } else {
              const errorData = await response.json();
              Swal.fire("Error", errorData.message || "Failed to add coupon", "error");
          }
      } catch (error) {
          console.error("Error adding coupon:", error);
          Swal.fire("Error", "Failed to add coupon. Please try again.", "error");
      }
    });
  </script>
</body>
</html>
