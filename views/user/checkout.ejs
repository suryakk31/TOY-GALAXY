<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Page</title>
    <link rel="stylesheet" href="/css/user/checkout.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

    <style>
       #removeCouponBtn {
        background-color: #FF6600;
        color: white;
        margin-left: 70px;
        border-radius: 5px;
        height: 20px;
        border-color: #FF6600;
       }

       #couponValidationMessage {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    
  <%- include('../partials/header') %>
      

        <main class="main-content">
            <div class="checkout-section">

                <div id="delivery-address-section" class="section">
                    <div class="section-header">
                        <div>
                            <h3>DELIVERY ADDRESS</h3>
                        </div>
                        <div class="change-link" id="change-address-link" onclick="showSection('delivery-address-section')">Change</div>
                    </div>
                    <div class="step-content active"> <!-- Active by default -->
                        <% addresses.forEach((address, index) => { %>
                            <div class="address-info">
                                <input type="radio" name="address" id="address<%= index + 1 %>" value="<%=address._id%>" <%= index === 0 ? 'checked' : '' %>>
                                <label for="address<%= index + 1 %>">
                                    <span><%= address.name %></span><br>
                                    <span><%= address.address %>, <%= address.locality %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %></span><br>
                                    <span><%= address.phone %></span>
                                </label>
                            </div>
                            
                        <% }); %>
                        
                        <form id="address-form" class="address-form" >

                            <label for="name">Name:</label>
                            <input type="text" id="name" name="name" required>
                  
                            <label for="address">Address:</label>
                            <input type="text" id="address" name="address" required>
                  
                            <label for="phone">Phone:</label>
                            <input type="text" id="phone" name="phone" required>
                  
                            <label for="locality">Locality:</label>
                            <input type="text" id="locality" name="locality" required>
                  
                            <label for="pincode">Pincode:</label>
                            <input type="text" id="pincode" name="pincode" required>
                  
                            <label for="state">State:</label>
                            <input type="text" id="state" name="state" required>
                  
                            
                            <label for="city">city:</label>
                            <input type="text" id="city" name="city" required>
                            
                     
                            
                            <button class="btn-primary" type="button" id="saveAddressBtn">SAVE ADDRESS  </button>
                            <button class="btn-primary" type="button" onclick="toggleAddressForm()">CANCEL</button>
                        </form>
                        
                        <a href="#" class="btn-primary" id="add-new-address" onclick="showNewAddressForm()">+ Add  new address</a>
                        <button class="btn-primary1" type="button" onclick="DeliverHere()"> DELIVER HERE</button>
                    </div>
                </div>


                <div id="order-summary-section" class="section">
                    <div class="section-header">
                        <h3>ORDER SUMMARY</h3>
                       
                    </div>
                    <div class="step-content">
                        <% if (cartItems.length === 0) { %>
                            <p>Your cart is empty.</p>
                        <% } else { %>
                            <% cartItems.forEach(item => { %>
                                <div class="order-item" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <div class="order-item-image" style="flex: 1;">
                                        <img src="<%= item.productId.image[0] %>" alt="Product Image" style="width: 100px; height: auto;">
                                    </div>
                                    <div class="order-item-details" style="flex: 3; padding-left: 15px;">
                                        <div>
                                            <h4 style="margin: 0; font-size: 16px;"><%= item.productId.name %></h4>
                                            <br>
                                            <h4 style="margin: 0; font-size: 16px;"><%= item.productId.category.name %></h4>
                                            <br>
                                            <h4 style="margin: 0; font-size: 16px;"><%= item.productId.description %></h4>
                                            <br>
                                            <h4 style="margin: 0; font-size: 16px;"> Quantity :<%= item.quantity%></h4>
                
                                     
                                        
                                            <p style="margin: 5px 0; font-size: 14px;"><span style="text-decoration: line-through; color: gray;"><%= item.productId.originalPrice %>
                                        
                                        </div>
                                       
                                    </div>
                                    <div class="order-item-actions" style="flex: 1; text-align: right;">
                                      
                                        
                                    </div>
                                </div>
                            <% }) %>
                        <% } %>
                        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                          <button class="btn-primary1" type="button" onclick="Continue()"> Continue</button> 
                       
                        </div>
                    </div>
                    
                </div>
                


                 <!-- Payment Options Section -->
                 <div id="payment-options-section" class="section">
                    <div class="section-header">
                        <div>
                            <h3>PAYMENT OPTIONS</h3>
                        </div>
                        <div class="change-link" id="change-payment-link" onclick="showSection('payment-options-section')">Change</div>
                    </div>
                    <div class="step-content">
                        <form action="#">
                            <div class="payment-method">
                                <br>
                                <input type="radio" name="paymentMethod" id="cod" value="Cash on delivery">
                                <label for="cod">
                                  <i class="bi bi-cash"></i>
                                  Cash on delivery
                                </label>
                                <br>
                                <input type="radio" name="paymentMethod" id="razor" value="Online payment">
                                <label for="cod">
                                  <i class="bi bi-credit-card"></i>
                                  Online payment
                                </label>
                                <br>
                                <input type="radio" name="wallet" id="wallet" value="Wallet payment">
                                <label for="wallet">
                                  <i class="bi bi-wallet2"></i>

                                  Wallet payment
                                </label>
                            </div>
                        </form>
                        <button id="place-order-btn" class="btn-primary" type="button" onclick="placeOrder()">PLACE ORDER</button>
                    </div>
                </div>

             <!-- Order Summary Section -->


               
            </div>

              

            

                  <div class="price-details-container">
                <aside class="price-details">
                    <h3>PRICE DETAILS</h3>
                    <ul>
                      <li> Total price<span>₹<%= originalTotal %></span></li>
                      <li>Category Offer <span>-₹<%= categoryOffer || '0.00' %></span></li>
                     
                      <li class="coupon-discount">Coupon Discount <span>-₹0</span></li>
                    
                      
                    
                    <li>Delivery Fee <span><%= deliveryFeeDisplay %></span></li>
                      <li>Total Payable: <span id="total-amount">₹<%= total %></span></li>

                  </ul>
                  <div id="couponContainer">
                    <button id="applyCouponBtn" class="apply-coupon-btn" onclick="openCouponModal()">
                      <i class='bx bxs-coupon'></i>
                      Apply Coupon
                    </button>
                    <div id="appliedCouponInfo" style="display: none;">
                      <span id="appliedCouponCode"></span>
                      <span id="appliedCouponDiscount"></span>
                      <button id="removeCouponBtn" onclick="removeCoupon()">Remove</button>
                    </div>
                  </div>
                  
                  <!-- Keep the modal and form as they were before -->
                    
                  
                </aside>
              
              </div>

              <div id="modalOverlay" class="modal-overlay"></div>
              <div id="couponModal" class="modal">
                  <span class="close-btn" onclick="closeModal()">&times;</span>
 
                
                  <form id="couponForm">
                    <label for="couponInput">Enter Coupon Code:</label>
                    <input type="text" id="couponInput" name="couponCode" required>
                    <button type="submit">Submit Coupon</button>
                  </form>
                  
                  <div id="couponValidationMessage"></div>

                  <div class="unavailable-coupons">
                    <h3> </h3>
                    <% coupon.forEach(coupon => { %>
                    <div class="coupon">
                        <div class="coupon-code">
                            <i class='bx bx-purchase-tag'></i> <%= coupon.couponCode %>
                        </div>
                        <div class="coupon-title">Get  <%= coupon.discount %> % off</div>
                        <div class="coupon-description"><%= coupon.description %> 
                          <br>
                          add minimum amount ₹ <%= coupon.minAmount %> to get this offer
                          <br>
                          This offer is valid for orders upto ₹ <%= coupon.maxAmount %>
                        </div>
                      
                        <div class="unavailable-message">Valid Till : <%= new Date(coupon.expiryDate).toLocaleDateString() %></div>
                    </div>
                    <% }) %>

                  </div>
               
              </div>


             

     
<div id="orderConfirmationModal" class="modal1" style="display: none;">
  <div class="modal-content1" style="text-align: center; padding: 20px; border-radius: 10px; background-color: white; width: 300px; margin: auto;">
      <div class="modal-body1">
          <div style="margin-bottom: 20px;">
              <div style="font-size: 50px; color: green; margin-bottom: 20px;">
                  &#10004;
              </div>
          </div>
          <h2>Order Placed Successfully!</h2>
         
          <p>Redirecting to order list page in <span id="countdown">5</span> seconds...</p>
  
      </div>
  </div>
</div>

               
                    
                
               
         
            
        </main>
    </div>
       
    <%- include('../partials/footer') %>
      
      
   



    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>



    document.getElementById('saveAddressBtn').addEventListener('click',async function(){
    // Gather form values
    const name = document.getElementById('name').value.trim();
    const address = document.getElementById('address').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const locality = document.getElementById('locality').value.trim();
    const pincode = document.getElementById('pincode').value.trim();
    const state = document.getElementById('state').value.trim();
    const city = document.getElementById('city').value.trim();

    let isValid = true;

    // Name validation
    if (name === '') {
      Swal.fire('Validation Error', 'Name is required.', 'error');
      isValid = false;
    }

    // Address validation
    if (address === '') {
      Swal.fire('Validation Error', 'Address is required.', 'error');
      isValid = false;
    }

    // Phone validation
    const phonePattern = /^[0-9]{10}$/;
    if (!phonePattern.test(phone)) {
      Swal.fire('Validation Error', 'Please enter a valid 10-digit phone number.', 'error');
      isValid = false;
    }

    // Locality validation
    if (locality === '') {
      Swal.fire('Validation Error', 'Locality is required.', 'error');
      isValid = false;
    }

    // Pincode validation
    const pincodePattern = /^[0-9]{6}$/;
    if (!pincodePattern.test(pincode)) {
      Swal.fire('Validation Error', 'Please enter a valid 6-digit pincode.', 'error');
      isValid = false;
    }

    // State validation
    if (state === '') {
      Swal.fire('Validation Error', 'State is required.', 'error');
      isValid = false;
    }

    // City validation
    if (city === '') {
      Swal.fire('Validation Error', 'City is required.', 'error');
      isValid = false;
    }

    
    if (isValid) {
      const formData = {
        name,
        address,
        phone,
        locality,
        pincode,
        state,
        city
      };

      try {
        const response = await fetch('/auth/addAddress', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          Swal.fire('Success!', 'Address saved successfully!', 'success').then(() => {
            window.location.reload();
          });
        } else {
          const result = await response.json();
          Swal.fire('Error!', 'Failed to save address: ' + result.message, 'error');
        }
      } catch (error) {
        Swal.fire('Error!', 'An error occurred: ' + error.message, 'error');
      }
    }
  });

    
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.step-content');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).querySelector('.step-content').classList.add('active');
    
            // Ensure the "Add New Address" button remains visible and styled correctly
            const addNewAddress = document.getElementById('add-new-address');
            addNewAddress.style.display = 'block';
            addNewAddress.style.backgroundColor = '#2874f0';
        }
    
        function showNextSection(nextSectionId, changeLinkId) {
            showSection(nextSectionId);
            document.getElementById(changeLinkId).style.display = 'block';
        }
    
        function toggleAddressForm() {
            const form = document.getElementById('address-form');
            const addNewAddress = document.getElementById('add-new-address');
            const isFormVisible = form.style.display === 'block';
    
            if (isFormVisible) {
                form.style.display = 'none';
                addNewAddress.style.display = 'block';
            } else {
                form.style.display = 'block';
                addNewAddress.style.display = 'none';
            }
        }
    
        function showNewAddressForm() {
            // Clear the form fields
            document.getElementById('name').value = '';
            document.getElementById('pincode').value = '';
            document.getElementById('address').value = '';
            document.getElementById('locality').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('phone').value = '';
   
            toggleAddressForm();
    
          
            document.getElementById('deliver-here-btn').style.display = 'block';
        }
  
    
        function DeliverHere() {
            showNextSection('order-summary-section', 'change-address-link');
        }

        function Continue() {
            showNextSection('payment-options-section', 'change-address-link');
        }

        function placeOrder() {
    const selectedAddress = document.querySelector('input[name="address"]:checked');
    const isCOD = document.getElementById('cod').checked;
    const isWallet = document.getElementById('wallet').checked;

    if (!selectedAddress) {
        Swal.fire('Error', 'Please select a delivery address', 'error');
        return;
    }

    if (isCOD) {
        processCODOrder();
    } else if (isWallet) {
        processWalletPayment();
    } else {
        initiateRazorpayPayment();
    }
}

function initiateRazorpayPayment() {
    let totalAmount = document.getElementById('total-amount').innerText;
    totalAmount = totalAmount.replace('₹', '').trim();

    fetch('/create-razorpay-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            amount: totalAmount * 100,
        })
    })
    .then(response => response.json())
    .then(order => {
        var options = {
            "key": order.key_id,
            "amount": order.amount,
            "currency": "INR",
            "name": "Kids Kastle",
            "description": "Toy Purchase",
            "order_id": order.id,
            "handler": function (response) {
                processOrder('Razorpay', response.razorpay_payment_id);
            },
            "prefill": {
                "name": "<%= userDatabase.firstName %> <%= userDatabase.lastName %>",
                "email": "<%= userDatabase.email %>",
                "contact": "<%= userDatabase.phoneNumber %>"
            },
            "theme": {
                "color": "#FF6600"
            }
        };
        var rzp = new Razorpay(options);
        rzp.open();
    })
    .catch(error => {
        console.error('Error creating Razorpay order:', error);
        Swal.fire('Error', 'There was an issue processing your payment. Please try again.', 'error');
    });
}

function processCODOrder() {
    processOrder('COD');
}

function processWalletPayment() {
  let totalAmount = document.getElementById('total-amount').innerText;
  totalAmount = totalAmount.replace('₹', '').trim();

  fetch('/process-wallet-payment',{
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
            amount: totalAmount
        })
  })
 .then(response => response.json())
    .then(data => {
        if (data.success) {
            processOrder('Wallet', data.transactionId);
        } else {
            Swal.fire('Error', data.message || 'Insufficient wallet balance', 'error');
        }
    })
    .catch(error => {
        console.error('Error processing wallet payment:', error);
        Swal.fire('Error', 'There was an issue processing your wallet payment. Please try again.', 'error');
    });
}
function processOrder(paymentMethod, paymentId = null) {
    const selectedAddress = document.querySelector('input[name="address"]:checked').value;

    const orderDetails = {
        address: selectedAddress,
        paymentMethod: paymentMethod,
        paymentId: paymentId,
        // Add other necessary details
    };

    fetch('/auth/checkout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(orderDetails)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Order placement failed');
        }
        return response.json();
    })
    .then(data => {
        if (data.message) {
            console.log('Order placed successfully:', data.message);
            showOrderConfirmationModal();
        } else if (data.error) {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'There was an issue placing your order. Please try again.', 'error');
    });
}




    function goToOrdersPage() {
        
        window.location.href = "/auth/order";
    }


    function showOrderConfirmationModal() {
    const modal = document.getElementById('orderConfirmationModal');
    modal.style.display = 'block'; 

    // Timer element
    const countdownElement = document.getElementById('countdown');
    let countdown = 5; // 5 seconds countdown

    // Update the countdown every second
    const countdownInterval = setInterval(() => {
        countdownElement.textContent = countdown;
        countdown -= 1;
    }, 1000);

    // Redirect after 5 seconds
    setTimeout(() => {
        clearInterval(countdownInterval);
        window.location.href = '/auth/order'; // Redirect to the orders page
    }, 5000); // 5000 milliseconds = 5 seconds
}







        
 
 
 let appliedCoupon = null;

function openCouponModal() {
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById('couponModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  document.getElementById('couponModal').style.display = 'none';
}

function updateCouponDisplay() {
  const applyCouponBtn = document.getElementById('applyCouponBtn');
  const appliedCouponInfo = document.getElementById('appliedCouponInfo');
  const appliedCouponCode = document.getElementById('appliedCouponCode');
  const appliedCouponDiscount = document.getElementById('appliedCouponDiscount');

  if (appliedCoupon) {
    applyCouponBtn.style.display = 'none';
    appliedCouponInfo.style.display = 'block';
    appliedCouponCode.textContent = appliedCoupon.couponCode;
    appliedCouponDiscount.textContent = `₹${appliedCoupon.discountAmount.toFixed(2)} OFF`;
  } else {
    applyCouponBtn.style.display = 'block';
    appliedCouponInfo.style.display = 'none';
  }
}

function removeCoupon() {
  appliedCoupon = null;
  localStorage.removeItem('coupon');
  updateCouponDisplay();
  
  const originalTotal = parseFloat(localStorage.getItem('originalTotal'));
  document.querySelector('#total-amount').innerText = `₹${originalTotal.toFixed(2)}`;
  document.querySelector('.coupon-discount span').innerText = '-₹0.00';
}

document.getElementById('couponForm').addEventListener('submit', function(e) {
  e.preventDefault(); 

  const couponCode = document.getElementById('couponInput').value;
  const totalAmount = parseFloat(document.querySelector('#total-amount').innerText.replace('₹', ''));
  const validationMessageElement = document.getElementById('couponValidationMessage');

  fetch('/validateCoupon', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ couponCode, totalAmount })
  })
  .then(response => response.json())
  .then(data => {
    if (data.isValid) {
      const { discount, discountAmount, minAmount, maxAmount } = data;

      appliedCoupon = {
        couponCode,
        discount,
        discountAmount,
        newTotal: totalAmount - discountAmount
      };

      localStorage.setItem('coupon', JSON.stringify(appliedCoupon));
      localStorage.setItem('originalTotal', totalAmount);

      document.querySelector('.coupon-discount span').innerText = `-₹${discountAmount.toFixed(2)}`;
      document.querySelector('#total-amount').innerText = `₹${appliedCoupon.newTotal.toFixed(2)}`;

      validationMessageElement.textContent = `Coupon applied successfully! You saved ₹${discountAmount.toFixed(2)}`;
      validationMessageElement.className = 'success';

      updateCouponDisplay();
      setTimeout(closeModal, 2000);

    } else {
      validationMessageElement.textContent = data.message;
                validationMessageElement.className = 'error';
    }
  })
  .catch(err => {
    console.error('Error:', err);
    validationMessageElement.textContent = 'An error occurred while validating the coupon. Please try again.';
    validationMessageElement.className = 'error';
  });
});

window.addEventListener('load', function() {
  const storedCoupon = localStorage.getItem('coupon');

  if (storedCoupon) {
    appliedCoupon = JSON.parse(storedCoupon);
    const originalTotal = parseFloat(localStorage.getItem('originalTotal'));

    document.querySelector('.coupon-discount span').innerText = `-₹${appliedCoupon.discountAmount.toFixed(2)}`;
    document.querySelector('#total-amount').innerText = `₹${appliedCoupon.newTotal.toFixed(2)}`;

    updateCouponDisplay();
  }
});

// Initialize coupon display on page load
updateCouponDisplay();

function clearCheckoutData() {
  localStorage.removeItem('coupon');
  localStorage.removeItem('originalTotal');
}
window.addEventListener('beforeunload', clearCheckoutData);

</script>

    
    
</body>
</html>
